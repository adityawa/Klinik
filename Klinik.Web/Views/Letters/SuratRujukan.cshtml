@model Klinik.Entities.Letter.LabReferenceLetterModel

@{
    ViewBag.Title = "SuratRujukan";
}
@section Styles {
    <link href="~/Content/jquery-ui.css" rel="stylesheet" />
    <style>
        .form-horizontal .control-label {
            text-align: left;
        }
    </style>
}

<div class="col-md-12">

    <section class="panel">
        <header class="panel-heading">
            <div class="panel-actions">
                <a href="#" class="fa fa-caret-down"></a>
            </div>
            <div>
                <h5 class="panel-title">
                    @Klinik.Resources.UIMessages.LetterCreation
                </h5>
            </div>
        </header>
        <div class="panel-body">
            <form class="form-horizontal">

                <div class="form-group">
                    <label class="col-md-2 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Patient</label>
                    <div class="col-md-3">
                        @Html.DatalistFor(x => x.ForPatient, new PatientDataList { Url = "/Loket/AllPatient" }, new { @id = "ddlPatient" })
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-2 control-label" for="inputDefault">@Klinik.Resources.UIMessages.MedicalCekDate</label>
                    <div class="col-md-3">
                        @Html.DropDownListFor(x => x.FormMedicalID, (IEnumerable<SelectListItem>)ViewBag.FormMedicalIds, new { @class = "form-control", @id = "ddlFrmMedIds" })
                    </div>

                </div>
                <div class="form-group col-md-9">
                    <label control-label" for="inputDefault">Surat : </label>
                    <table class="table table-striped table-bordered">
                        <tr>
                            <td>
                                @Klinik.Resources.UIMessages.LabReferenceLetter
                            </td>
                            <td>
                                <button id="btnLabRefLtr" class="btn btn-info">Create</button>

                            </td>
                        </tr>
                        <tr>
                            <td>
                                @Klinik.Resources.UIMessages.HealthBodyLetter
                            </td>
                            <td>
                                <button id="btnHealthBdLtr" class="btn btn-info">Create</button>
                            </td>

                        </tr>
                        <tr>
                            <td>
                                @Klinik.Resources.UIMessages.TakeMedicineReferenceLetter
                            </td>
                            <td>
                                <button id="btntakeMedRefLtr" class="btn btn-info">Create</button>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                @Klinik.Resources.UIMessages.MedicalActionAcceptanceLetter
                            </td>
                            <td>
                                <button id="btnAcceptMedRefLtr" class="btn btn-info">Create</button>
                            </td>
                        </tr>
                    </table>
                </div>
            </form>

        </div>
    </section>
</div>

<div id="pnlMedicalRef" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="myModalLabel">Surat Rujukan Lab Keluar</h3>
            </div>

            <div class="modal-body col-md-12" style="margin-top:10px">
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Name</label>
                    <div class="col-md-6">
                        <input type="text" disabled class="form-control" id="tbNamePatient" />
                    </div>
                </div>

                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Gender</label>
                    <div class="col-md-6">
                        <input type="text" disabled class="form-control" id="tbGender" />
                    </div>
                </div>

                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.SAP</label>
                    <div class="col-md-6">
                        <input type="text" disabled class="form-control" id="tbSAP" />
                    </div>
                </div>

                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.HPNumber</label>
                    <div class="col-md-6">
                        <input type="text" disabled class="form-control" id="tbHP" />
                    </div>
                </div>

                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Birthdate</label>
                    <div class="col-md-6">
                        <input type="text" disabled class="form-control" id="tbTglLahir" />
                    </div>
                </div>

                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.DokterPengirim</label>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="tbDokterPengirim" />
                    </div>
                </div>

                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Age</label>
                    <div class="col-md-6">
                        <input type="text" disabled class="form-control" id="tbUsia" />
                    </div>
                </div>

                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.MedicalCekDate</label>
                    <div class="col-md-6">
                        <input type="text" disabled class="form-control" id="tbTglPeriksa" />
                    </div>
                </div>
            </div>

            <div style="width:70%; padding:10px">
                <table id="tbLabItem" class="table table-striped table-bordered dt-responsive" cellspacing="0">
                    <thead>
                        <tr>
                            <th><input name="select_all" value="1" type="checkbox"></th>
                            <th>@Klinik.Resources.UIMessages.ID</th>
                            <th>@Klinik.Resources.UIMessages.LabItemCategory</th>
                            <th>@Klinik.Resources.UIMessages.Name</th>
                        </tr>
                    </thead>
                </table>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnSaveAndPreview" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<div id="pnlBerbadanSehat" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="text-align:center" class="modal-title" id="myModalLabel">Surat Berbadan Sehat</h3>
                <label style="text-align:center" class="control-label" for="lblHealthBdLetNo"></label>
            </div>
            <div class="modal-body col-md-12" style="margin-top:10px">

                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Name</label>
                    <div class="col-md-6">
                        <input type="text" disabled class="form-control" id="tbNm_HBL" />
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Height</label>
                    <div class="col-md-4">
                        <input type="text" disabled class="form-control" id="tbTb_HBL" />
                    </div>
                    <label class="col-md-1 control-label" for="inputDefault">Cm</label>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Birthdate</label>
                    <div class="col-md-6">
                        <input type="text" disabled class="form-control" id="tbBirthDt_HBL" />
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Weight</label>
                    <div class="col-md-4">
                        <input type="text" disabled class="form-control" id="tbBb_HBL" />
                    </div>
                    <label class="col-md-1 control-label" for="inputDefault">Kg</label>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Pekerjaan</label>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="tbPekerjaan_HBL" />
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.BloodType</label>
                    <div class="col-md-4">
                        <input type="text" disabled class="form-control" id="tbBloodType_HBL" />
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Address</label>
                    <div class="col-md-6">
                        @*<input type="text" class="form-control" id="tbAddr_HBL" />*@
                        <textarea class="form-control" disabled id="tbAddr_HBL" style="min-width: 100%"></textarea>
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.BloodPress</label>
                    <div class="col-md-4">
                        <input type="text" disabled class="form-control" id="tbBloodPres_HBL" />
                    </div>
                    <label class="col-md-1 control-label" for="inputDefault">MmHg</label>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.BPJSNo</label>
                    <div class="col-md-6">
                        <input type="text" disabled class="form-control" id="tbBpjs_HBL" />
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.HR</label>
                    <div class="col-md-4">
                        <input type="text" disabled class="form-control" id="tbHR_HBL" />
                    </div>
                    <label class="col-md-3 control-label" for="inputDefault">x menit</label>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Dinyatakan</label>
                    <div class="col-md-6">
                        <select id="selperyataan" class="form-control">
                            <option value="health">Sehat</option>
                            <option value="unhealth">Tidak Sehat</option>
                        </select>
                    </div>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.RR</label>
                    <div class="col-md-4">
                        <input type="text" disabled class="form-control" id="tbRR_HBL" />
                    </div>
                    <label class="col-md-3 control-label" for="inputDefault">x menit</label>
                </div>
                <div class="form-group col-md-6">
                    <label class="col-md-3 control-label" for="inputDefault">@Klinik.Resources.UIMessages.Visus</label>
                    <div class="col-md-4">
                        <input type="text" disabled class="form-control" id="tbVisus_HBL" />
                    </div>
                    
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="btnSaveAndPreview" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="~/Scripts/jquery-ui.js"></script>
    <script src="~/Scripts/MvcDatalist/mvc-datalist.js"></script>
    <script>
        var _PatientId;
        var dataLab = [];
        var rows_selected = [];
        var FormMedId;
        [].forEach.call(document.getElementsByClassName('datalist'), function (element) {
            new MvcDatalist(element);
        });

        new MvcDatalist(document.querySelector('.datalist'), {
            events: {
                select: function (data, triggerChanges) {
                    for (var i = 0; i < data.length; i++) {
                        _PatientId = data[i].Id;
                    }
                    GetDateCheckUp(_PatientId);
                }
            }
        });

        $(function () {
            toastr.options = {
                "closeButton": true,
                "positionClass": "toast-top-full-width",
                "onclick": null,
                "showDuration": "0",
                "hideDuration": "0",
                "timeOut": "0",
                "showMethod": "fadeIn"
            };
            $('#tbCekDate').datepicker({
                format: "dd/mm/yyyy",
                changeMonth: true,
                changeYear: true
            });

            $('#btnHealthBdLtr').click(function (e) {
                e.preventDefault();
                $('#pnlBerbadanSehat').modal({
                    backdrop: 'static'
                });
            });

            $('#btnSaveAndPreview').click(function (e) {
                if (window.FormData != undefined) {
                    if (rows_selected.length <= 0) {
                        alert('please specify at least one Lab Item');
                    }
                    else {
                        var form_data = new FormData();
                        form_data.append("FormMedicalId", FormMedId);
                        form_data.append("LabItems", JSON.stringify(rows_selected));
                        form_data.append("DokterPengirim", $('#tbDokterPengirim').val());
                        $.ajax({
                            type: 'POST',
                            url: '/Letters/SaveAndPreviewRujukanLab',
                            contentType: false,
                            processData: false,
                            data: form_data,
                            async: "true",
                            success: function (result) {
                                if (result.Status == true) {
                                    //var full_uri = "http://" + location.host + "/Letters/PrintSuratRujukanLabKeluar?FormMedId="+result.FormMedicalId;
                                    var full_uri = "http://" + location.host + "/Letters/ExportSuratRujukanLabKeluar2Pdf?FormMedId=" + result.FormMedicalId;
                                    window.open(full_uri, "_blank");
                                    $('#pnlMedicalRef').hide();
                                }
                                else {
                                    alert('something went wrong');
                                }

                            },
                            error: function (xhr, status, p3, p4) {
                                var err = "Error " + " " + status + " " + p3 + " " + p4;
                                if (xhr.responseText && xhr.responseText[0] == "{")
                                    err = JSON.parse(xhr.responseText).Message;
                                console.log(err);
                            }
                        });
                    }

                }
                else {
                    toastr.error("Your Browser is not support Form Data");
                }
            });

            $('#btnLabRefLtr').click(function (e) {
                e.preventDefault();
                if (window.FormData != undefined) {
                    var form_data = new FormData();
                    form_data.append("forPatient", _PatientId);
                    form_data.append("FormMedicalID", $('#ddlFrmMedIds').val());
                    form_data.append("TglPeriksa", $('#ddlFrmMedIds option:selected').text());
                    $.ajax({
                        url: '/Letters/CreateSuratRujukanLab',
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        dataType: 'JSON',
                        data: form_data,
                        async: "true",
                        success: function (result) {
                            if (result.Status) {
                                $('#tbNamePatient').val(result.PatientName);
                                $('#tbGender').val(result.Gender);
                                $('#tbSAP').val(result.SAP);
                                $('#tbHP').val(result.NoHP);
                                $('#tbTglLahir').val(result.BirthDate);
                                $('#tbUsia').val(result.Usia);
                                $('#tbTglPeriksa').val(result.TglPeriksa);
                                FormMedId = result.FormMedicalId;
                                dataLab = result.Data;
                                $("#tbDokterPengirim").prop('disabled', false);
                                bindTable();

                                $('#pnlMedicalRef').modal({
                                    backdrop: 'static'
                                });
                            }
                            else {
                                toastr.error(result.Message);
                            }
                        }
                    });
                }
                else {
                    toastr.error("Your Browser is not support Form Data");
                }
                return false;
            });
        });

        function bindTable() {
            var table = $('#tbLabItem').DataTable({
                "autoWidth": false,
                "processing": true,
                "filter": true,
                "orderMulti": false,
                "pageLength": 10,
                "data": dataLab,
                "destroy": true,
                "columnDefs":
                    [

                        {
                            'targets': 0,
                            'searchable': false,
                            'orderable': false,
                            'width': '1%',
                            'className': 'dt-body-center',
                            'render': function (data, type, full, meta) {
                                return '<input type="checkbox">';
                            }
                        },
                        {
                            "targets": [1],
                            "visible": false,
                            "searchable": false,
                            "data": "Id"
                        },

                        {
                            "targets": [2],
                            "searchable": true,
                            "orderable": true,
                            "data": "LabItemCategoryName"
                        },


                        {
                            "targets": [3],
                            "searchable": true,
                            "orderable": true,
                            "data": "Name"
                        }




                    ],


                'rowCallback': function (row, data, dataIndex) {
                    // Get row ID
                    var rowId = data.Id;

                    //var cek = $.inArray(rowId, rows_selected);
                    //var cek1 = data.Id;

                    if ($.inArray(rowId, rows_selected) != -1) {
                        $(row).find('input[type="checkbox"]').prop('checked', true);
                        $(row).addClass('selected');
                    }
                }
            });

            $('#tbLabItem tbody').on('click', 'input[type="checkbox"]', function (e) {
                var $row = $(this).closest('tr');
                var data = table.row($row).data();
                var rowId = data.Id;
                var index = $.inArray(rowId, rows_selected);
                if (this.checked && index === -1) {
                    rows_selected.push(rowId);
                } else if (!this.checked && index !== -1) {
                    rows_selected.splice(index, 1);
                }

                if (this.checked) {
                    $row.addClass('selected');
                } else {
                    $row.removeClass('selected');
                }
                updateDataTableSelectAllCtrl(table);
                e.stopPropagation();
            });


            $('#tbLabItem').on('click', 'tbody td, thead th:first-child', function (e) {
                $(this).parent().find('input[type="checkbox"]').trigger('click');
            });


            $('thead input[name="select_all"]', table.table().container()).on('click', function (e) {
                if (this.checked) {
                    $('#tbLabItem tbody input[type="checkbox"]:not(:checked)').trigger('click');
                } else {
                    $('#tbLabItem tbody input[type="checkbox"]:checked').trigger('click');
                }

                // Prevent click event from propagating to parent
                e.stopPropagation();
            });


            table.on('draw', function () {
                // Update state of "Select all" control
                updateDataTableSelectAllCtrl(table);
            });
        }



        function updateDataTableSelectAllCtrl(table) {
            var $table = table.table().node();
            var $chkbox_all = $('tbody input[type="checkbox"]', $table);
            var $chkbox_checked = $('tbody input[type="checkbox"]:checked', $table);
            var chkbox_select_all = $('thead input[name="select_all"]', $table).get(0);

            // If none of the checkboxes are checked
            if ($chkbox_checked.length === 0) {
                chkbox_select_all.checked = false;
                if ('indeterminate' in chkbox_select_all) {
                    chkbox_select_all.indeterminate = false;
                }

                // If all of the checkboxes are checked
            } else if ($chkbox_checked.length === $chkbox_all.length) {
                chkbox_select_all.checked = true;
                if ('indeterminate' in chkbox_select_all) {
                    chkbox_select_all.indeterminate = false;
                }

                // If some of the checkboxes are checked
            } else {
                chkbox_select_all.checked = true;
                if ('indeterminate' in chkbox_select_all) {
                    chkbox_select_all.indeterminate = true;
                }
            }
        }

        function GetDateCheckUp(PatientId) {
            $.get("/Letters/GetTanggalPemeriksaan", { PatientId: PatientId }, function (data) {
                $("#ddlFrmMedIds").empty();
                $.each(data, function (index, row) {
                    $("#ddlFrmMedIds").append('<option value="' + row.FormMedicalID + '">' + row.TransactionDateStr + '</option>');

                });
            });
        }
    </script>
}
